<%- include('layout.ejs', { title: title, user: user, content: `
<div class="section">
    <div class="section-header">
        <h2>会员充值</h2>
    </div>

    <div class="recharge-container">
        <!-- 搜索会员 -->
        <div class="search-section">
            <h3>搜索会员</h3>
            <div class="search-bar">
                <input type="text" id="memberSearchInput" placeholder="输入手机号或姓名搜索...">
                <button class="btn btn-primary" onclick="searchMember()">搜索</button>
            </div>
        </div>

        <!-- 会员信息显示 -->
        <div id="memberInfoSection" class="member-info-section" style="display: none;">
            <h3>会员信息</h3>
            <div class="member-details">
                <div class="detail-row">
                    <label>手机号:</label>
                    <span id="memberPhone"></span>
                </div>
                <div class="detail-row">
                    <label>姓名:</label>
                    <span id="memberName"></span>
                </div>
                <div class="detail-row">
                    <label>当前余额:</label>
                    <span id="memberBalance" class="balance-amount"></span>
                </div>
                <div class="detail-row">
                    <label>会员等级:</label>
                    <span id="memberLevel"></span>
                </div>
            </div>

            <!-- 充值表单 -->
            <div class="recharge-form">
                <h3>充值信息</h3>
                <form id="rechargeForm">
                    <div class="form-group">
                        <label for="rechargeAmount">充值金额</label>
                        <input type="number" id="rechargeAmount" name="amount" step="0.01" min="0.01" required>
                        <div class="quick-amount-buttons">
                            <button type="button" class="quick-amount-btn" onclick="setAmount(50)">¥50</button>
                            <button type="button" class="quick-amount-btn" onclick="setAmount(100)">¥100</button>
                            <button type="button" class="quick-amount-btn" onclick="setAmount(200)">¥200</button>
                            <button type="button" class="quick-amount-btn" onclick="setAmount(500)">¥500</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentMethod">支付方式</label>
                        <select id="paymentMethod" name="paymentMethod" required>
                            <option value="cash">现金</option>
                            <option value="wechat">微信支付</option>
                            <option value="alipay">支付宝</option>
                            <option value="bank">银行卡</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="rechargeRemark">备注</label>
                        <textarea id="rechargeRemark" name="remark" rows="3" placeholder="可选的备注信息..."></textarea>
                    </div>
                    
                    <div class="recharge-preview">
                        <div class="preview-row">
                            <label>充值前余额:</label>
                            <span id="beforeBalance">¥0.00</span>
                        </div>
                        <div class="preview-row">
                            <label>充值金额:</label>
                            <span id="previewAmount">¥0.00</span>
                        </div>
                        <div class="preview-row total">
                            <label>充值后余额:</label>
                            <span id="afterBalance">¥0.00</span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="icon">💰</i> 确认充值
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 最近充值记录 -->
        <div class="recent-recharges">
            <h3>最近充值记录</h3>
            <div class="recharge-list" id="recentRecharges">
                <!-- 动态加载充值记录 -->
            </div>
        </div>
    </div>
</div>
`, scripts: `
<script>
let currentMember = null;

// 搜索会员
async function searchMember() {
    const searchTerm = document.getElementById('memberSearchInput').value.trim();
    if (!searchTerm) {
        alert('请输入手机号或姓名');
        return;
    }
    
    try {
        const response = await fetch(\`/api/members?search=\${searchTerm}\`);
        const members = await response.json();
        
        if (members.length === 0) {
            alert('未找到会员');
            return;
        }
        
        currentMember = members[0];
        displayMemberInfo(currentMember);
        loadRecentRecharges(currentMember.id);
        
    } catch (error) {
        console.error('Search error:', error);
        alert('搜索失败，请重试');
    }
}

// 显示会员信息
function displayMemberInfo(member) {
    document.getElementById('memberPhone').textContent = member.phone;
    document.getElementById('memberName').textContent = member.name || '未设置';
    document.getElementById('memberBalance').textContent = \`¥\${member.balance}\`;
    document.getElementById('memberLevel').innerHTML = \`
        <span class="level-badge level-\${member.level}">
            \${member.level === 'bronze' ? '青铜' : member.level === 'silver' ? '白银' : member.level === 'gold' ? '黄金' : '铂金'}
        </span>
    \`;
    document.getElementById('beforeBalance').textContent = \`¥\${member.balance}\`;
    
    document.getElementById('memberInfoSection').style.display = 'block';
    updateRechargePreview();
}

// 设置快捷金额
function setAmount(amount) {
    document.getElementById('rechargeAmount').value = amount;
    updateRechargePreview();
}

// 更新充值预览
function updateRechargePreview() {
    const amount = parseFloat(document.getElementById('rechargeAmount').value) || 0;
    const beforeBalance = parseFloat(currentMember?.balance || 0);
    const afterBalance = beforeBalance + amount;
    
    document.getElementById('previewAmount').textContent = \`¥\${amount.toFixed(2)}\`;
    document.getElementById('afterBalance').textContent = \`¥\${afterBalance.toFixed(2)}\`;
}

// 加载最近充值记录
async function loadRecentRecharges(memberId) {
    try {
        // 这里需要添加获取充值记录的API
        const response = await fetch(\`/api/members/\${memberId}/recharges\`);
        const recharges = await response.json();
        
        const container = document.getElementById('recentRecharges');
        container.innerHTML = '';
        
        if (recharges.length === 0) {
            container.innerHTML = '<div class="no-data">暂无充值记录</div>';
            return;
        }
        
        recharges.forEach(recharge => {
            const item = document.createElement('div');
            item.className = 'recharge-item';
            item.innerHTML = \`
                <div class="recharge-info">
                    <div class="recharge-amount">+¥\${recharge.amount}</div>
                    <div class="recharge-time">\${new Date(recharge.createdAt).toLocaleString()}</div>
                    <div class="recharge-method">\${getPaymentMethodName(recharge.paymentMethod)}</div>
                </div>
                <div class="recharge-balance">
                    余额: ¥\${recharge.afterBalance}
                </div>
            \`;
            container.appendChild(item);
        });
        
    } catch (error) {
        console.error('Load recharges error:', error);
        document.getElementById('recentRecharges').innerHTML = '<div class="no-data">加载失败</div>';
    }
}

// 获取支付方式名称
function getPaymentMethodName(method) {
    const methods = {
        'cash': '现金',
        'wechat': '微信支付',
        'alipay': '支付宝',
        'bank': '银行卡'
    };
    return methods[method] || method;
}

// 充值表单提交
document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentMember) {
        alert('请先搜索会员');
        return;
    }
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch(\`/api/members/\${currentMember.id}/recharge\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(\`充值成功！新余额: ¥\${result.newBalance}\`);
            
            // 更新显示的余额
            currentMember.balance = result.newBalance;
            displayMemberInfo(currentMember);
            
            // 清空表单
            document.getElementById('rechargeForm').reset();
            updateRechargePreview();
            
            // 重新加载充值记录
            loadRecentRecharges(currentMember.id);
            
        } else {
            alert(result.error || '充值失败');
        }
    } catch (error) {
        console.error('Recharge error:', error);
        alert('充值失败，请重试');
    }
});

// 监听充值金额变化
document.getElementById('rechargeAmount').addEventListener('input', updateRechargePreview);

// 回车搜索
document.getElementById('memberSearchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchMember();
    }
});
</script>
` }) %>