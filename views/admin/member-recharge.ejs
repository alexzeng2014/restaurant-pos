<%- include('layout.ejs', { title: title, user: user, content: `
<div class="section">
    <div class="section-header">
        <h2>ä¼šå‘˜å……å€¼</h2>
    </div>

    <div class="recharge-container">
        <!-- æœç´¢ä¼šå‘˜ -->
        <div class="search-section">
            <h3>æœç´¢ä¼šå‘˜</h3>
            <div class="search-bar">
                <input type="text" id="memberSearchInput" placeholder="è¾“å…¥æ‰‹æœºå·æˆ–å§“åæœç´¢...">
                <button class="btn btn-primary" onclick="searchMember()">æœç´¢</button>
            </div>
        </div>

        <!-- ä¼šå‘˜ä¿¡æ¯æ˜¾ç¤º -->
        <div id="memberInfoSection" class="member-info-section" style="display: none;">
            <h3>ä¼šå‘˜ä¿¡æ¯</h3>
            <div class="member-details">
                <div class="detail-row">
                    <label>æ‰‹æœºå·:</label>
                    <span id="memberPhone"></span>
                </div>
                <div class="detail-row">
                    <label>å§“å:</label>
                    <span id="memberName"></span>
                </div>
                <div class="detail-row">
                    <label>å½“å‰ä½™é¢:</label>
                    <span id="memberBalance" class="balance-amount"></span>
                </div>
                <div class="detail-row">
                    <label>ä¼šå‘˜ç­‰çº§:</label>
                    <span id="memberLevel"></span>
                </div>
            </div>

            <!-- å……å€¼è¡¨å• -->
            <div class="recharge-form">
                <h3>å……å€¼ä¿¡æ¯</h3>
                <form id="rechargeForm">
                    <div class="form-group">
                        <label for="rechargeAmount">å……å€¼é‡‘é¢</label>
                        <input type="number" id="rechargeAmount" name="amount" step="0.01" min="0.01" required>
                        <div class="quick-amount-buttons">
                            <button type="button" class="quick-amount-btn" onclick="setAmount(50)">Â¥50</button>
                            <button type="button" class="quick-amount-btn" onclick="setAmount(100)">Â¥100</button>
                            <button type="button" class="quick-amount-btn" onclick="setAmount(200)">Â¥200</button>
                            <button type="button" class="quick-amount-btn" onclick="setAmount(500)">Â¥500</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentMethod">æ”¯ä»˜æ–¹å¼</label>
                        <select id="paymentMethod" name="paymentMethod" required>
                            <option value="cash">ç°é‡‘</option>
                            <option value="wechat">å¾®ä¿¡æ”¯ä»˜</option>
                            <option value="alipay">æ”¯ä»˜å®</option>
                            <option value="bank">é“¶è¡Œå¡</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="rechargeRemark">å¤‡æ³¨</label>
                        <textarea id="rechargeRemark" name="remark" rows="3" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯..."></textarea>
                    </div>
                    
                    <div class="recharge-preview">
                        <div class="preview-row">
                            <label>å……å€¼å‰ä½™é¢:</label>
                            <span id="beforeBalance">Â¥0.00</span>
                        </div>
                        <div class="preview-row">
                            <label>å……å€¼é‡‘é¢:</label>
                            <span id="previewAmount">Â¥0.00</span>
                        </div>
                        <div class="preview-row total">
                            <label>å……å€¼åä½™é¢:</label>
                            <span id="afterBalance">Â¥0.00</span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="icon">ğŸ’°</i> ç¡®è®¤å……å€¼
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æœ€è¿‘å……å€¼è®°å½• -->
        <div class="recent-recharges">
            <h3>æœ€è¿‘å……å€¼è®°å½•</h3>
            <div class="recharge-list" id="recentRecharges">
                <!-- åŠ¨æ€åŠ è½½å……å€¼è®°å½• -->
            </div>
        </div>
    </div>
</div>
`, scripts: `
<script>
let currentMember = null;

// æœç´¢ä¼šå‘˜
async function searchMember() {
    const searchTerm = document.getElementById('memberSearchInput').value.trim();
    if (!searchTerm) {
        alert('è¯·è¾“å…¥æ‰‹æœºå·æˆ–å§“å');
        return;
    }
    
    try {
        const response = await fetch(\`/api/members?search=\${searchTerm}\`);
        const members = await response.json();
        
        if (members.length === 0) {
            alert('æœªæ‰¾åˆ°ä¼šå‘˜');
            return;
        }
        
        currentMember = members[0];
        displayMemberInfo(currentMember);
        loadRecentRecharges(currentMember.id);
        
    } catch (error) {
        console.error('Search error:', error);
        alert('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
function displayMemberInfo(member) {
    document.getElementById('memberPhone').textContent = member.phone;
    document.getElementById('memberName').textContent = member.name || 'æœªè®¾ç½®';
    document.getElementById('memberBalance').textContent = \`Â¥\${member.balance}\`;
    document.getElementById('memberLevel').innerHTML = \`
        <span class="level-badge level-\${member.level}">
            \${member.level === 'bronze' ? 'é’é“œ' : member.level === 'silver' ? 'ç™½é“¶' : member.level === 'gold' ? 'é»„é‡‘' : 'é“‚é‡‘'}
        </span>
    \`;
    document.getElementById('beforeBalance').textContent = \`Â¥\${member.balance}\`;
    
    document.getElementById('memberInfoSection').style.display = 'block';
    updateRechargePreview();
}

// è®¾ç½®å¿«æ·é‡‘é¢
function setAmount(amount) {
    document.getElementById('rechargeAmount').value = amount;
    updateRechargePreview();
}

// æ›´æ–°å……å€¼é¢„è§ˆ
function updateRechargePreview() {
    const amount = parseFloat(document.getElementById('rechargeAmount').value) || 0;
    const beforeBalance = parseFloat(currentMember?.balance || 0);
    const afterBalance = beforeBalance + amount;
    
    document.getElementById('previewAmount').textContent = \`Â¥\${amount.toFixed(2)}\`;
    document.getElementById('afterBalance').textContent = \`Â¥\${afterBalance.toFixed(2)}\`;
}

// åŠ è½½æœ€è¿‘å……å€¼è®°å½•
async function loadRecentRecharges(memberId) {
    try {
        // è¿™é‡Œéœ€è¦æ·»åŠ è·å–å……å€¼è®°å½•çš„API
        const response = await fetch(\`/api/members/\${memberId}/recharges\`);
        const recharges = await response.json();
        
        const container = document.getElementById('recentRecharges');
        container.innerHTML = '';
        
        if (recharges.length === 0) {
            container.innerHTML = '<div class="no-data">æš‚æ— å……å€¼è®°å½•</div>';
            return;
        }
        
        recharges.forEach(recharge => {
            const item = document.createElement('div');
            item.className = 'recharge-item';
            item.innerHTML = \`
                <div class="recharge-info">
                    <div class="recharge-amount">+Â¥\${recharge.amount}</div>
                    <div class="recharge-time">\${new Date(recharge.createdAt).toLocaleString()}</div>
                    <div class="recharge-method">\${getPaymentMethodName(recharge.paymentMethod)}</div>
                </div>
                <div class="recharge-balance">
                    ä½™é¢: Â¥\${recharge.afterBalance}
                </div>
            \`;
            container.appendChild(item);
        });
        
    } catch (error) {
        console.error('Load recharges error:', error);
        document.getElementById('recentRecharges').innerHTML = '<div class="no-data">åŠ è½½å¤±è´¥</div>';
    }
}

// è·å–æ”¯ä»˜æ–¹å¼åç§°
function getPaymentMethodName(method) {
    const methods = {
        'cash': 'ç°é‡‘',
        'wechat': 'å¾®ä¿¡æ”¯ä»˜',
        'alipay': 'æ”¯ä»˜å®',
        'bank': 'é“¶è¡Œå¡'
    };
    return methods[method] || method;
}

// å……å€¼è¡¨å•æäº¤
document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentMember) {
        alert('è¯·å…ˆæœç´¢ä¼šå‘˜');
        return;
    }
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch(\`/api/members/\${currentMember.id}/recharge\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(\`å……å€¼æˆåŠŸï¼æ–°ä½™é¢: Â¥\${result.newBalance}\`);
            
            // æ›´æ–°æ˜¾ç¤ºçš„ä½™é¢
            currentMember.balance = result.newBalance;
            displayMemberInfo(currentMember);
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('rechargeForm').reset();
            updateRechargePreview();
            
            // é‡æ–°åŠ è½½å……å€¼è®°å½•
            loadRecentRecharges(currentMember.id);
            
        } else {
            alert(result.error || 'å……å€¼å¤±è´¥');
        }
    } catch (error) {
        console.error('Recharge error:', error);
        alert('å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
});

// ç›‘å¬å……å€¼é‡‘é¢å˜åŒ–
document.getElementById('rechargeAmount').addEventListener('input', updateRechargePreview);

// å›è½¦æœç´¢
document.getElementById('memberSearchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchMember();
    }
});
</script>
` }) %>