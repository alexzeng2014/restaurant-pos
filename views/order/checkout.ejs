<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»“è´¦ - é¤å…ç‚¹é¤ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/order.css">
</head>
<body>
    <div class="order-container">
        <div class="order-header">
            <div class="table-info">
                <span>é¤æ¡Œ: <%= table.name || table.number %></span>
                <a href="/order/menu?tableId=<%= table.id %>" class="change-table">è¿”å›èœå•</a>
            </div>
            <div class="user-section">
                <div id="userInfo">
                    <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€æ›´æ–° -->
                </div>
            </div>
        </div>

        <div class="checkout-container">
            <div class="checkout-content">
                <h2>è®¢å•ç»“ç®—</h2>
                
                <!-- è®¢å•è¯¦æƒ… -->
                <div class="order-details">
                    <h3>è®¢å•è¯¦æƒ…</h3>
                    <div class="order-items" id="orderItems">
                        <!-- è®¢å•é¡¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- ç»“ç®—ä¿¡æ¯ -->
                <div class="checkout-summary">
                    <div class="summary-row">
                        <span>å°è®¡:</span>
                        <span id="subtotal">Â¥0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>æœåŠ¡è´¹:</span>
                        <span id="serviceFee">Â¥0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>æ€»è®¡:</span>
                        <span id="totalAmount">Â¥0.00</span>
                    </div>
                    <% if (currentMember) { %>
                    <div class="member-balance">
                        <span>ä¼šå‘˜ä½™é¢:</span>
                        <span>Â¥<%= currentMember.balance %></span>
                    </div>
                    <% } %>
                </div>

                <!-- æ”¯ä»˜æ–¹å¼ -->
                <div class="payment-methods">
                    <h3>æ”¯ä»˜æ–¹å¼</h3>
                    <div class="payment-options">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="cash" checked>
                            <span class="payment-icon">ğŸ’µ</span>
                            <span class="payment-name">ç°é‡‘</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="wechat">
                            <span class="payment-icon">ğŸ’š</span>
                            <span class="payment-name">å¾®ä¿¡</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="alipay">
                            <span class="payment-icon">ğŸ’™</span>
                            <span class="payment-name">æ”¯ä»˜å®</span>
                        </label>
                        <% if (currentMember) { %>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="member">
                            <span class="payment-icon">ğŸ’</span>
                            <span class="payment-name">ä¼šå‘˜ä½™é¢</span>
                        </label>
                        <% } %>
                    </div>
                </div>

                <!-- å¤‡æ³¨ -->
                <div class="order-notes">
                    <label for="orderNotes">è®¢å•å¤‡æ³¨</label>
                    <textarea id="orderNotes" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œè¯·åœ¨æ­¤å¤‡æ³¨..."></textarea>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="checkout-actions">
                    <button class="btn btn-secondary" onclick="backToMenu()">è¿”å›èœå•</button>
                    <button class="btn btn-primary btn-lg" onclick="submitOrder()">
                        <i class="icon">ğŸ’°</i> ç¡®è®¤ä¸‹å•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script src="/js/order.js"></script>
    <script>
        let currentMember = <%= currentMember ? JSON.stringify(currentMember) : 'null' %>;
        let tableId = <%= table.id %>;

        // åŠ è½½è´­ç‰©è½¦æ•°æ®
        function loadCartData() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const orderItems = document.getElementById('orderItems');
            
            if (cart.length === 0) {
                orderItems.innerHTML = '<div class="no-items">è´­ç‰©è½¦ä¸ºç©º</div>';
                return;
            }

            let subtotal = 0;
            orderItems.innerHTML = cart.map(item => `
                <div class="order-item">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">Â¥${item.price}</div>
                    </div>
                    <div class="item-quantity">
                        <span>æ•°é‡: ${item.quantity}</span>
                    </div>
                    <div class="item-total">
                        <span>å°è®¡: Â¥${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                </div>
            `).join('');

            // è®¡ç®—æ€»è®¡
            subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const serviceFee = subtotal * 0.1; // 10%æœåŠ¡è´¹
            const total = subtotal + serviceFee;

            document.getElementById('subtotal').textContent = `Â¥${subtotal.toFixed(2)}`;
            document.getElementById('serviceFee').textContent = `Â¥${serviceFee.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `Â¥${total.toFixed(2)}`;
        }

        // è¿”å›èœå•
        function backToMenu() {
            window.location.href = `/order/menu?tableId=${tableId}`;
        }

        // æäº¤è®¢å•
        async function submitOrder() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                alert('è´­ç‰©è½¦ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ èœå“');
                return;
            }

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const notes = document.getElementById('orderNotes').value;

            const orderData = {
                tableId: tableId,
                items: cart,
                paymentMethod: paymentMethod,
                notes: notes
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('è®¢å•æäº¤æˆåŠŸï¼');
                    localStorage.removeItem('cart'); // æ¸…ç©ºè´­ç‰©è½¦
                    window.location.href = '/order/tables'; // è¿”å›é¤æ¡Œé€‰æ‹©
                } else {
                    alert(result.error || 'è®¢å•æäº¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Submit order error:', error);
                alert('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
        function updateUserDisplay() {
            const userInfo = document.getElementById('userInfo');
            if (currentMember) {
                userInfo.innerHTML = `
                    <div class="member-info">
                        <span>æ¬¢è¿, ${currentMember.name || currentMember.phone}</span>
                        <span class="member-badge">ä¼šå‘˜</span>
                    </div>
                `;
            } else {
                userInfo.innerHTML = `
                    <div class="guest-info">
                        <span>æ¸¸å®¢æ¨¡å¼</span>
                    </div>
                `;
            }
        }

        // åˆå§‹åŒ–
        updateUserDisplay();
        loadCartData();
    </script>
</body>
</html>