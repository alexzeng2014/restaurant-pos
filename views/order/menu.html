<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菜单 - 餐厅点餐系统</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/order.css">
</head>
<body>
    <div class="order-container">
        <!-- 头部信息 -->
        <div class="order-header">
            <div class="table-info">
                <span>餐桌: {{table.name || table.number}}</span>
                <a href="/order/tables" class="change-table">更换餐桌</a>
            </div>
            <div class="user-section">
                <div id="userInfo">
                    <button class="btn btn-sm" onclick="showLoginModal()">会员登录</button>
                    <button class="btn btn-sm btn-secondary" onclick="guestMode()">游客模式</button>
                </div>
            </div>
        </div>

        <!-- 分类导航 -->
        <div class="category-nav">
            <button class="category-btn active" onclick="filterCategory('')">全部</button>
            {% for category in categories %}
            <button class="category-btn" onclick="filterCategory({{category.id}})">{{category.name}}</button>
            {% endfor %}
        </div>

        <!-- 菜品列表 -->
        <div class="menu-content">
            <div class="dishes-list" id="dishesList">
                {% for dish in dishes %}
                <div class="menu-dish-item" data-category-ids="{{dish.Category ? dish.Category.id : ''}}">
                    <div class="dish-image">
                        {% if dish.image %}
                        <img src="{{dish.image}}" alt="{{dish.name}}" onerror="this.src='/images/default-dish.png'">
                        {% else %}
                        <img src="/images/default-dish.png" alt="{{dish.name}}">
                        {% endif %}
                        {% if dish.isSpecial %}
                        <span class="special-badge">特色</span>
                        {% endif %}
                    </div>
                    <div class="dish-info">
                        <h3>{{dish.name}}</h3>
                        <p class="dish-description">{{dish.description || '暂无描述'}}</p>
                        <div class="dish-prices">
                            <div class="price">¥{{dish.price}}</div>
                            {% if currentMember and dish.memberPrice != dish.price %}
                            <div class="member-price">会员价: ¥{{dish.memberPrice}}</div>
                            {% endif %}
                        </div>
                        <div class="dish-stock">
                            {% if dish.stock === -1 %}
                            库存充足
                            {% else %}
                            库存: {{dish.stock}}
                            {% endif %}
                        </div>
                        <div class="dish-actions">
                            <button class="btn btn-sm btn-primary" onclick="addToCart({{dish.id}}, '{{dish.name}}', {% if currentMember %}{{dish.memberPrice}}{% else %}{{dish.price}}{% endif %})">
                                加入购物车
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="no-dishes">暂无菜品</div>
                {% endfor %}
            </div>

            <!-- 购物车 -->
            <div class="cart-sidebar" id="cartSidebar">
                <div class="cart-header">
                    <h3>购物车</h3>
                    <span id="cartCount">0</span>
                </div>
                <div class="cart-items" id="cartItems">
                    <div class="empty-cart">购物车为空</div>
                </div>
                <div class="cart-summary">
                    <div class="cart-total">
                        <span>总计:</span>
                        <span id="cartTotal">¥0.00</span>
                    </div>
                    {% if currentMember %}
                    <div class="member-balance">
                        <span>会员余额:</span>
                        <span>¥{{currentMember.balance}}</span>
                    </div>
                    {% endif %}
                    <button class="btn btn-primary btn-lg" onclick="goToCheckout()" id="checkoutBtn" disabled>
                        去结账
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 会员登录模态框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>会员登录</h3>
                <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="memberPhone">手机号</label>
                    <input type="tel" id="memberPhone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="memberPassword">密码</label>
                    <input type="password" id="memberPassword" name="password">
                    <small>如未设置密码，可直接点击登录</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('loginModal')">取消</button>
                    <button type="submit" class="btn btn-primary">登录</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/order.js"></script>
    <script>
        let currentMember = {{currentMember ? JSON.stringify(currentMember) : 'null'}};
        let cart = [];
        let tableId = {{table.id}};

        // 显示登录模态框
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        // 游客模式
        function guestMode() {
            fetch('/order/guest-mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentMember = null;
                    updateUserDisplay();
                    updateCartDisplay();
                    location.reload();
                }
            });
        }

        // 会员登录
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/order/member-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentMember = result.member;
                    closeModal('loginModal');
                    updateUserDisplay();
                    updateCartDisplay();
                    location.reload();
                } else {
                    alert(result.error || '登录失败');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('登录失败，请重试');
            }
        });

        // 更新用户显示
        function updateUserDisplay() {
            const userInfo = document.getElementById('userInfo');
            if (currentMember) {
                userInfo.innerHTML = `
                    <div class="member-info">
                        <span>欢迎, ${currentMember.name || currentMember.phone}</span>
                        <button class="btn btn-sm" onclick="guestMode()">退出</button>
                    </div>
                `;
            } else {
                userInfo.innerHTML = `
                    <button class="btn btn-sm" onclick="showLoginModal()">会员登录</button>
                    <button class="btn btn-sm btn-secondary" onclick="guestMode()">游客模式</button>
                `;
            }
        }

        // 筛选分类
        function filterCategory(categoryId) {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const dishes = document.querySelectorAll('.menu-dish-item');
            dishes.forEach(dish => {
                const categoryIds = dish.dataset.categoryIds;
                if (!categoryId || categoryIds.includes(categoryId.toString())) {
                    dish.style.display = 'flex';
                } else {
                    dish.style.display = 'none';
                }
            });
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 初始化
        updateUserDisplay();
        loadCartFromStorage();
    </script>
</body>
</html>