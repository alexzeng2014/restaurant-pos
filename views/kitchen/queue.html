{% extends "layout.html" %}

{% block content %}
<div class="kitchen-container">
    <div class="kitchen-header">
        <h1>å¨æˆ¿è®¢å•é˜Ÿåˆ—</h1>
        <div class="kitchen-stats">
            <div class="stat-item">
                <span class="stat-label">å¾…åˆ¶ä½œ</span>
                <span class="stat-value" id="pendingCount">{{orders.length}}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">åˆ¶ä½œä¸­</span>
                <span class="stat-value" id="preparingCount">0</span>
            </div>
        </div>
    </div>

    <div class="orders-queue">
        {% for order in orders %}
        <div class="order-card" data-order-id="{{order.id}}" data-status="{{order.status}}">
            <div class="order-header">
                <div class="order-info">
                    <div class="order-number">è®¢å•å·: {{order.orderNumber}}</div>
                    <div class="order-table">é¤æ¡Œ: {{order.Table.name || order.Table.number}}</div>
                    <div class="order-time">ä¸‹å•æ—¶é—´: {{order.createdAt.toLocaleString()}}</div>
                    {% if order.Member %}
                    <div class="order-member">ä¼šå‘˜: {{order.Member.name || order.Member.phone}}</div>
                    {% endif %}
                </div>
                <div class="order-status">
                    <span class="status-badge status-{{order.status}}">
                        {% if order.status === 'confirmed' %}å¾…åˆ¶ä½œ{% elif order.status === 'preparing' %}åˆ¶ä½œä¸­{% else %}{{order.status}}{% endif %}
                    </span>
                </div>
            </div>
            
            <div class="order-items">
                {% for item in order.OrderItems %}
                <div class="order-item">
                    <div class="item-info">
                        <div class="item-name">{{item.Dish.name}}</div>
                        <div class="item-quantity">x {{item.quantity}}</div>
                    </div>
                    <div class="item-notes">
                        {% if item.notes %}
                        <div class="notes">å¤‡æ³¨: {{item.notes}}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="order-actions">
                {% if order.status === 'confirmed' %}
                <button class="btn btn-primary" onclick="updateOrderStatus({{order.id}}, 'preparing')">
                    å¼€å§‹åˆ¶ä½œ
                </button>
                {% elif order.status === 'preparing' %}
                <button class="btn btn-success" onclick="updateOrderStatus({{order.id}}, 'ready')">
                    åˆ¶ä½œå®Œæˆ
                </button>
                {% endif %}
                <div class="order-total">
                    æ€»è®¡: Â¥{{order.finalAmount}}
                </div>
            </div>
            
            {% if order.notes %}
            <div class="order-notes">
                <strong>è®¢å•å¤‡æ³¨:</strong> {{order.notes}}
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="no-orders">
            <div class="no-orders-icon">ğŸ½ï¸</div>
            <h3>æš‚æ— å¾…å¤„ç†è®¢å•</h3>
            <p>å½“å‰æ²¡æœ‰éœ€è¦åˆ¶ä½œçš„è®¢å•</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// æ›´æ–°è®¢å•çŠ¶æ€
async function updateOrderStatus(orderId, status) {
    try {
        const response = await fetch(`/kitchen/order/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ›´æ–°è®¢å•å¡ç‰‡æ˜¾ç¤º
            const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
            if (orderCard) {
                orderCard.dataset.status = status;
                
                // æ›´æ–°çŠ¶æ€å¾½ç« 
                const statusBadge = orderCard.querySelector('.status-badge');
                statusBadge.className = `status-badge status-${status}`;
                statusBadge.textContent = status === 'preparing' ? 'åˆ¶ä½œä¸­' : 'å·²å®Œæˆ';
                
                // æ›´æ–°æ“ä½œæŒ‰é’®
                const actionsContainer = orderCard.querySelector('.order-actions');
                if (status === 'preparing') {
                    actionsContainer.innerHTML = `
                        <button class="btn btn-success" onclick="updateOrderStatus(${orderId}, 'ready')">
                            åˆ¶ä½œå®Œæˆ
                        </button>
                        <div class="order-total">
                            æ€»è®¡: Â¥${orderCard.querySelector('.order-total').textContent.replace('æ€»è®¡: Â¥', '')}
                        </div>
                    `;
                } else if (status === 'ready') {
                    actionsContainer.innerHTML = `
                        <div class="order-completed">
                            <span class="completed-icon">âœ“</span>
                            <span>åˆ¶ä½œå®Œæˆ</span>
                        </div>
                        <div class="order-total">
                            æ€»è®¡: Â¥${orderCard.querySelector('.order-total').textContent.replace('æ€»è®¡: Â¥', '')}
                        </div>
                    `;
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification('è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
            
            // å¦‚æœè®¢å•å®Œæˆï¼Œ3ç§’åç§»é™¤
            if (status === 'ready') {
                setTimeout(() => {
                    orderCard.style.animation = 'slideOut 0.5s ease';
                    setTimeout(() => {
                        orderCard.remove();
                        checkEmptyState();
                    }, 500);
                }, 3000);
            }
            
        } else {
            showNotification(result.error || 'æ›´æ–°å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('Update order status error:', error);
        showNotification('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
function updateStats() {
    const confirmedOrders = document.querySelectorAll('.order-card[data-status="confirmed"]');
    const preparingOrders = document.querySelectorAll('.order-card[data-status="preparing"]');
    
    document.getElementById('pendingCount').textContent = confirmedOrders.length;
    document.getElementById('preparingCount').textContent = preparingOrders.length;
}

// æ£€æŸ¥ç©ºçŠ¶æ€
function checkEmptyState() {
    const ordersQueue = document.querySelector('.orders-queue');
    const orderCards = ordersQueue.querySelectorAll('.order-card');
    
    if (orderCards.length === 0) {
        ordersQueue.innerHTML = `
            <div class="no-orders">
                <div class="no-orders-icon">ğŸ½ï¸</div>
                <h3>æš‚æ— å¾…å¤„ç†è®¢å•</h3>
                <p>å½“å‰æ²¡æœ‰éœ€è¦åˆ¶ä½œçš„è®¢å•</p>
            </div>
        `;
    }
}

// å®šæ—¶åˆ·æ–°è®¢å•
function startOrderRefresh() {
    setInterval(async () => {
        try {
            const response = await fetch('/kitchen/queue');
            const html = await response.text();
            
            // è§£æHTMLè·å–æ–°è®¢å•
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newOrders = doc.querySelectorAll('.order-card');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°è®¢å•
            const currentOrders = document.querySelectorAll('.order-card');
            if (newOrders.length > currentOrders.length) {
                // æ˜¾ç¤ºæ–°è®¢å•æç¤º
                showNotification('æœ‰æ–°è®¢å•ï¼', 'info');
                
                // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                    audio.play();
                } catch (e) {
                    console.log('Audio notification not supported');
                }
            }
            
            // æ›´æ–°é¡µé¢ï¼ˆå¯é€‰ï¼Œæˆ–ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°ï¼‰
            // location.reload();
            
        } catch (error) {
            console.error('Refresh orders error:', error);
        }
    }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    startOrderRefresh();
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // ç©ºæ ¼é”®å¼€å§‹åˆ¶ä½œç¬¬ä¸€ä¸ªè®¢å•
        if (e.code === 'Space' && e.target === document.body) {
            e.preventDefault();
            const firstOrder = document.querySelector('.order-card[data-status="confirmed"] button');
            if (firstOrder) {
                firstOrder.click();
            }
        }
    });
});

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .order-card {
        transition: all 0.3s ease;
    }
    
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-confirmed {
        background-color: #f39c12;
        color: white;
    }
    
    .status-preparing {
        background-color: #3498db;
        color: white;
    }
    
    .status-ready {
        background-color: #27ae60;
        color: white;
    }
    
    .order-completed {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #27ae60;
        font-weight: 500;
    }
    
    .completed-icon {
        background-color: #27ae60;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}